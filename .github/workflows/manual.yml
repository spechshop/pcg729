name: CMake on a single platform

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Instalar dependÃªncias do sistema
        run: |
          sudo apt-get update
          sudo apt-get install -y \
          build-essential \
          autoconf \
          automake \
          cmake \
          make \
          gcc \
          g++ \
          pkg-config \
          re2c \
          bison \
          flex \
          m4 \
          curl \
          wget \
          git \
          unzip \
          ca-certificates \
          libtool \
          libxml2 \
          libxml2-dev \
          libsqlite3-dev \
          libssl-dev \
          openssl \
          libcurl4 \
          libcurl4-openssl-dev \
          zlib1g \
          zlib1g-dev \
          libzip-dev \
          libjpeg-dev \
          libpng-dev \
          libwebp-dev \
          libonig-dev \
          libreadline-dev \
          libgmp-dev \
          libicu-dev \
          libxslt1-dev \
          libffi-dev \
          libbz2-dev \
          libfreetype6-dev \
          libevent-dev \
          libpcre3-dev \
          libsqlite3-0 \
          libgcc-12-dev \
          libstdc++-12-dev

      - name: Preparar ambiente PHP
        run: |
          ./bin/setup-runtime
          bin/php composer install
          bin/php bin/spc doctor --auto-fix

      - name: Download extensÃµes
        run: bin/php bin/spc download --for-extensions "bcg729,psampler,opus,swoole,bcmath,bz2,ctype,curl,dom,exif,fileinfo,filter,gd,gmp,hash,iconv,intl,json,mbstring,mysqli,mysqlnd,openssl,pcntl,pcre,PDO,pdo_mysql,Phar,posix,readline,Reflection,session,soap,sockets,sodium,SPL,sqlite3,uv,standard,tokenizer,yaml,zip,zlib"

      # -----------------------------------------------------------
      # ðŸ”¥ BAIXAR PHP-SRC 8.5.0 DEPOIS DO SPC DOWNLOAD
      # -----------------------------------------------------------
      - name: Baixar e preparar php-src 8.5.0
        run: |
          mkdir -p source
          cd source

          echo "Baixando php-src 8.5.0..."
          curl -L -o php-src.zip https://github.com/php/php-src/archive/refs/tags/php-8.5.0.zip

          echo "Extraindo..."
          unzip php-src.zip

          echo "Movendo para source/php-src..."
          EXTRACTED=$(ls -d php-src-* | head -n 1)
          mv "$EXTRACTED" php-src

          rm -f php-src.zip
          ls -lah php-src

      - name: Build
        run: bin/php bin/spc build --build-cli "bcg729,psampler,opus,swoole,bcmath,bz2,ctype,curl,dom,exif,fileinfo,filter,gd,gmp,hash,iconv,intl,json,mbstring,mysqli,mysqlnd,openssl,pcntl,pcre,PDO,pdo_mysql,Phar,posix,readline,Reflection,session,soap,sockets,sodium,SPL,sqlite3,uv,standard,tokenizer,yaml,zip,zlib" --debug --enable-zts

      - name: Test
        working-directory: ${{ github.workspace }}/build
        run: buildroot/bin/php -i
