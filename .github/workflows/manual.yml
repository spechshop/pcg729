- name: Baixar e preparar php-src 8.5.0 (Spech mode)
  run: |
    mkdir -p source
    cd source

    echo "[Spech] Baixando php-src 8.5.0..."
    curl -L -o php-src.zip https://github.com/php/php-src/archive/refs/tags/php-8.5.0.zip

    echo "[Spech] Criando área isolada de extração..."
    rm -rf tmp_extract
    mkdir tmp_extract

    echo "[Spech] Extraindo zip dentro de tmp_extract..."
    unzip php-src.zip -d tmp_extract >/dev/null

    echo "[Spech] Localizando diretório real do php-src..."
    PHP_DIR=$(find tmp_extract -maxdepth 1 -type d ! -name tmp_extract | head -n 1)

    if [ -z "$PHP_DIR" ]; then
        echo "[Spech][ERRO] Nenhum diretório encontrado após unzip."
        exit 1
    fi

    echo "[Spech] Diretório detectado: $PHP_DIR"

    echo "[Spech] Verificando indicadores de php-src..."
    if [ ! -f "$PHP_DIR/configure" ] && [ ! -f "$PHP_DIR/README.md" ] && [ ! -d "$PHP_DIR/Zend" ]; then
        echo "[Spech][ERRO] A pasta extraída não parece ser php-src!"
        ls -lah "$PHP_DIR"
        exit 1
    fi

    echo "[Spech] Movendo php-src para source/php-src..."
    rm -rf php-src
    mv "$PHP_DIR" php-src

    echo "[Spech] Limpando arquivos temporários..."
    rm -f php-src.zip
    rm -rf tmp_extract

    echo "[Spech] php-src preparado:"
    ls -lah php-src
