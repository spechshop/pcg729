name: CMake on a single platform

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  BUILD_TYPE: Release

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Instalar dependÃªncias do sistema
        run: |
          sudo apt-get update
          sudo apt-get install -y \
          build-essential \
          autoconf \
          automake \
          cmake \
          make \
          gcc \
          g++ \
          pkg-config \
          re2c \
          bison \
          flex \
          m4 \
          curl \
          wget \
          git \
          unzip \
          ca-certificates \
          libtool \
          libxml2 \
          libxml2-dev \
          libsqlite3-dev \
          libssl-dev \
          openssl \
          libcurl4 \
          libcurl4-openssl-dev \
          zlib1g \
          zlib1g-dev \
          libzip-dev \
          libjpeg-dev \
          libpng-dev \
          libwebp-dev \
          libonig-dev \
          libreadline-dev \
          libgmp-dev \
          libicu-dev \
          libxslt1-dev \
          libffi-dev \
          libbz2-dev \
          libfreetype6-dev \
          libevent-dev \
          libpcre3-dev \
          libsqlite3-0 \
          libgcc-12-dev \
          libstdc++-12-dev

      - name: Preparar ambiente PHP
        run: |
          ./bin/setup-runtime
          bin/php composer install
          bin/php bin/spc download --with-php=8.5 --for-extensions "opus,bcg729"        
          ls downloads -A
          bin/php bin/spc doctor --auto-fix
  
      - name: Build
        run: bin/php bin/spc build --build-cli "bcg729" --debug --enable-zts

      - name: Test
        working-directory: ${{ github.workspace }}/workflowspacesafe
        run: buildroot/bin/php -i
